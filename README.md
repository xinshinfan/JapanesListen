# 日语博客语音播放器

一个用于提取日语博客内容并合成语音播放的Web应用程序，支持本地和远程部署。

## 功能特点

- **多行文本输入**：支持直接输入或粘贴多行日语文本
- **网页内容提取**：可从日语博客网址自动提取文章内容
- **语音合成**：使用本地VITS/VOICEVOX API将日语文本转换为语音
- **句子分割**：自动将文章分割为独立的句子进行播放
- **播放控制**：支持播放/暂停、上一句/下一句等控制功能
- **快捷键支持**：提供空格键、方向键等快捷操作
- **段落保留**：自动保留文章的段落结构
- **自动播放控制**：可启用/禁用自动播放下一句功能
- **远程访问支持**：通过ngrok等工具支持远程访问

## 工作原理

### 整体架构

本应用采用**客户端-服务器架构**，通过Node.js服务器代理前端请求到本地VOICEVOX引擎，解决了跨域和远程访问的问题。

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│   浏览器    │────────▶│ Node.js     │────────▶│  VOICEVOX   │
│  (前端)     │         │  服务器     │         │   引擎      │
│             │◀────────│  (代理)     │◀────────│  (本地)     │
└─────────────┘         └─────────────┘         └─────────────┘
     ngrok/localhost      localhost:3000        127.0.0.1:50021
```

### 为什么需要服务器代理？

#### 1. **跨域问题（CORS）**
- 浏览器的同源策略阻止前端直接访问不同端口的API
- `http://localhost:3000` 无法直接访问 `http://127.0.0.1:50021`
- 服务器代理可以绕过浏览器的同源限制

#### 2. **远程访问问题**
- 当通过ngrok发布应用时，用户浏览器无法访问服务器本地的 `http://127.0.0.1:50021`
- 服务器运行在服务器上，而`127.0.0.1`指的是用户本地机器
- 通过服务器代理，所有API请求都在服务器端处理

#### 3. **ngrok免费版限制**
- ngrok免费版会显示警告页面，可能影响API调用
- 通过设置`ngrok-skip-browser-warning`响应头，可以跳过警告页面

### 数据流程

1. **用户操作**：
   - 用户在浏览器中输入日语内容或URL
   - 点击"处理内容"按钮

2. **前端请求**：
   - 前端JavaScript通过`/api/*`路径发送API请求
   - 请求头包含`ngrok-skip-browser-warning`以跳过ngrok警告

3. **服务器代理**：
   - Node.js服务器接收API请求
   - 将请求转发到本地VOICEVOX引擎（`http://127.0.0.1:50021`）
   - 处理VOICEVOX的响应并返回给前端

4. **语音合成流程**：
   ```
   前端 → /api/speakers → 服务器 → VOICEVOX → 返回语音角色列表
   前端 → /api/audio_query → 服务器 → VOICEVOX → 返回音频参数
   前端 → /api/synthesis → 服务器 → VOICEVOX → 返回音频数据
   ```

### 核心组件说明

#### 1. **前端（客户端）**
- **HTML**：用户界面，包括输入框、播放器控制、内容显示区域
- **CSS**：样式设计，提供良好的用户体验
- **JavaScript**：
  - 处理用户输入和交互
  - 发送API请求到服务器
  - 控制音频播放
  - 管理播放状态和进度

#### 2. **Node.js服务器（代理）**
- **Express框架**：提供HTTP服务和路由
- **CORS支持**：允许跨域请求
- **API端点**：
  - `GET /api/speakers`：获取可用语音角色列表
  - `POST /api/audio_query`：获取音频合成参数
  - `POST /api/synthesis`：合成音频数据
- **静态文件服务**：提供HTML、CSS、JS文件

#### 3. **VOICEVOX引擎**
- 本地运行的语音合成引擎
- 提供RESTful API接口
- 支持多种日语语音角色
- 基于VITS（Variational Inference with adversarial learning for end-to-end Text-to-Speech）技术

### 部署模式

#### 本地部署
```
浏览器 → localhost:3000 → Node.js服务器 → 127.0.0.1:50021 (VOICEVOX)
```

#### 远程部署（ngrok）
```
用户浏览器 → ngrok URL → ngrok隧道 → localhost:3000 → Node.js服务器 → 127.0.0.1:50021 (VOICEVOX)
```

### 技术细节

#### 请求头处理
```javascript
// 前端添加跳过ngrok警告的请求头
headers: { 'ngrok-skip-browser-warning': 'any' }

// 服务器添加响应头
res.setHeader('ngrok-skip-browser-warning', 'any');
res.setHeader('Access-Control-Allow-Origin', '*');
```

#### 错误处理
- 重试机制：API请求失败时自动重试（最多3次）
- 指数退避：重试间隔逐渐增加（100ms, 200ms, 400ms）
- 用户提示：友好的错误信息显示

## 安装和使用

### 前提条件

- 已安装Node.js和npm
- 已运行本地VOICEVOX引擎（默认端口：50021）

### 安装依赖

```bash
npm install
```

### 启动应用

1. **启动服务器**：
   ```bash
   npm start
   ```
   服务器将在 `http://localhost:3000` 上运行

2. **本地访问**：
   在浏览器中访问：`http://localhost:3000`

3. **远程访问（可选）**：
   使用ngrok发布应用：
   ```bash
   ngrok http 3000
   ```
   然后使用ngrok提供的URL访问应用

## 支持的功能

### 输入方式

1. **直接输入日语文本**：
   - 在文本框中直接输入多行日语内容
   - 支持粘贴复制的日语文本

2. **输入博客网址**：
   - 输入日语博客的完整URL
   - 系统会自动提取文章内容

### 语音播放

- **播放控制**：播放/暂停、上一句、下一句
- **语音角色选择**：可从下拉菜单中选择不同的语音角色
- **句子高亮**：当前播放的句子会自动高亮显示
- **进度显示**：显示当前播放进度和句子总数

## 使用说明

1. **输入内容**：
   - 在多行文本框中输入日语内容或博客网址
   - 点击"处理内容"按钮

2. **查看内容**：
   - 处理完成后，文章内容会显示在"文章内容"区域
   - 系统会自动保留段落结构

3. **播放语音**：
   - 选择喜欢的语音角色
   - 使用播放器控制按钮或快捷键进行操作

## 快捷键

- **空格键**：播放/暂停
- **← 左箭头**：上一句
- **→ 右箭头**：下一句

## 技术实现

- **前端技术**：HTML5, CSS3, JavaScript (ES6+)
- **语音合成**：VITS/VOICEVOX API（本地部署）
- **网页内容提取**：使用DOM解析和正则表达式
- **文本处理**：
  - 保留换行符的文本清理
  - 基于日语标点符号的句子分割
  - 段落结构保留

## 项目结构

```
.
├── japanese_blog_player.html  # 主应用页面
├── blog_player.css            # 样式文件
├── blog_player.js             # 核心功能脚本
├── multi_line_test.html       # 多行文本测试文件
└── README.md                  # 项目说明文档
```

## 注意事项

1. **VOICEVOX引擎**：
   - 确保已正确安装并运行VOICEVOX引擎
   - 默认API地址：http://127.0.0.1:50021

2. **网页内容提取**：
   - 并非所有日语博客都支持内容提取
   - 部分网站可能有反爬虫限制

3. **日语支持**：
   - 仅支持日语文本的语音合成
   - 混合语言文本可能无法正确处理

## 故障排除

1. **无法连接VOICEVOX**：
   - 检查VOICEVOX引擎是否正常运行
   - 确认API地址和端口是否正确

2. **内容提取失败**：
   - 确认输入的URL是否为有效的日语博客地址
   - 部分网站可能不支持内容提取

3. **语音播放无声音**：
   - 检查浏览器音频设置
   - 确认VOICEVOX引擎是否正常响应

## 更新日志

- **v1.0**：
  - 初始版本发布
  - 支持多行文本输入
  - 实现网页内容提取
  - 集成VOICEVOX语音合成

## 许可证

本项目采用MIT许可证。# JapanesListen
